<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GSCS 업무 표준 변환기</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --lg-red: #ec455a;
            --lg-dark: #333;
            --bg-light: #f8f9fa;
            --border-color: #ddd;
            --primary-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
            background: #fff;
            overflow: hidden;
        }

        /* 표 일괄 적용 스타일 (에디터/미리보기 동시 적용) */
        .xfe_just_info {
            width: auto;
            border-collapse: collapse;
            border-spacing: 0;
            table-layout: auto;
        }

        .xfe_just_info th,
        .xfe_just_info td {
            border: 1px solid #ccc;
            padding: 8px;
            white-space: pre-wrap;
            word-break: break-all;
            text-align: left;
        }

        .img-only {
            margin: 20px 0;
            text-align: left;
        }

        .img-only img {
            max-width: 100%;
            height: auto;
            border: 1px solid #eee;
        }

        .mobile-tabs {
            display: none;
            width: 100%;
            background: #fff;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .mobile-tabs button {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: bold;
            color: #666;
        }

        .mobile-tabs button.active {
            color: var(--lg-red);
            border-bottom: 3px solid var(--lg-red);
        }

        .editor-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            background: #fff;
        }

        .preview-panel {
            flex: 1;
            padding: 30px;
            background-color: #f8f9fa;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--lg-dark);
            display: flex;
            align-items: center;
            letter-spacing: -0.5px;
        }

        .panel-title i {
            margin-right: 12px;
            color: var(--lg-red);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 15px;
            color: #444;
        }

        .label-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .editable-label {
            flex: 1;
            font-weight: 700;
            font-size: 15px;
            color: #444;
            border: 1px dashed transparent;
            background: transparent;
            padding: 4px 8px;
            border-radius: 4px;
            width: auto;
            cursor: text;
            transition: border-color 0.2s, background 0.2s;
        }

        .editable-label:hover {
            border-color: #bbb;
            background: #f5f5f5;
        }

        .editable-label:focus {
            border-color: var(--lg-red);
            background: #fff;
            outline: none;
        }

        .btn-clear-section {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px 10px;
            font-size: 12px;
            color: #888;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-clear-section:hover {
            background: #fff0f0;
            border-color: var(--lg-red);
            color: var(--lg-red);
        }

        input[type="text"]:not(.editable-label),
        textarea,
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input[type="text"]:not(.editable-label):focus,
        select:focus {
            border-color: var(--lg-red);
            outline: none;
        }

        .editor-container {
            border: 1px solid var(--border-color);
            background: #fff;
            overflow: visible;
            margin-top: 5px;
            display: flex;
            flex-direction: column;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #fff;
            border-bottom: 2px solid var(--lg-red);
            padding: 15px 30px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .editor-toolbar {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background: #fdfdfd;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            position: sticky;
            top: 60px;
            /* 제목 높이 고려 */
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
        }

        .editor-toolbar button,
        .custom-file-upload {
            background: #fff;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #555;
            transition: all 0.2s;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            box-sizing: border-box;
        }

        .custom-file-upload input[type="file"] {
            display: none;
        }

        .custom-file-upload i {
            margin-right: 5px;
        }

        .editor-toolbar button:hover,
        .custom-file-upload:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }

        .editor-toolbar select {
            padding: 0 8px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 30px;
            background: #fff;
            width: auto;
        }

        .font-family-select {
            width: 110px !important;
        }

        .font-size-select {
            width: 60px !important;
        }

        .btn-font-step {
            min-width: 30px;
            font-weight: bold;
        }

        .btn-font-step span {
            font-size: 10px;
            margin-left: 2px;
            color: #0078d4;
        }

        /* Color Tool Split Button */
        .color-tool-split {
            display: inline-flex;
            align-items: stretch;
            border: 1px solid #ddd;
            border-radius: 4px;
            height: 30px;
            background: #fff;
            overflow: hidden;
        }

        .color-btn-main {
            padding: 0 8px;
            background: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #eee;
        }

        .color-btn-main:hover {
            background-color: #f5f5f5;
        }

        .color-btn-arrow {
            padding: 0 6px;
            background: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #666;
        }

        .color-btn-arrow:hover {
            background-color: #f5f5f5;
        }

        .color-icon-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        .color-icon-wrapper b {
            font-size: 14px;
            font-family: 'Malgun Gothic', '맑은 고딕', sans-serif;
        }

        .color-icon-wrapper i {
            font-size: 13px;
        }

        .color-bar {
            width: 16px;
            height: 3px;
            margin-top: 1px;
            border: 0.5px solid rgba(0, 0, 0, 0.1);
        }

        .editor-content-view {
            min-height: 120px;
            padding: 18px;
            outline: none;
            font-size: 14px;
            line-height: 1.6;
            word-break: break-all;
            background-color: #fff;
            position: relative;
            /* For absolute child placement */
        }

        .editor-content-view table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            box-sizing: border-box;
        }

        .editor-content-view td,
        .editor-content-view th {
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .btn-convert {
            background: linear-gradient(135deg, var(--lg-red), #d6334a);
            color: #fff;
            border: none;
            padding: 14px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 25px;
            width: 100%;
            box-shadow: 0 4px 15px rgba(236, 69, 90, 0.3);
            transition: all 0.3s;
        }

        .btn-convert:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 69, 90, 0.4);
        }

        .btn-add-section {
            background: #fff;
            color: var(--lg-red);
            border: 2px dashed #ec455a44;
            padding: 12px;
            width: 100%;
            margin: 20px 0;
            cursor: pointer;
            font-weight: 700;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .btn-add-section:hover {
            background: #fff5f6;
            border-color: var(--lg-red);
        }

        .dynamic-section {
            position: relative;
            padding: 25px;
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 25px;
            background: #fdfdfd;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .btn-remove-section {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #ccc;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            transition: color 0.2s;
        }

        .btn-remove-section:hover {
            color: var(--lg-red);
        }

        .preview-frame {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            min-height: 500px;
            flex: 1;
            padding: 0;
            box-shadow: var(--primary-shadow);
            overflow: hidden;
        }

        .code-area {
            margin-top: 25px;
            position: relative;
        }

        #codeOutput {
            width: 100%;
            height: 180px;
            font-family: 'Consolas', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 18px;
            border-radius: 8px;
            border: none;
            resize: none;
            box-sizing: border-box;
            font-size: 13px;
            line-height: 1.5;
        }

        .resize-handle-top {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 12px;
            background: #eee;
            cursor: ns-resize;
            border-radius: 4px 4px 0 0;
            margin-bottom: -4px;
            position: relative;
            z-index: 10;
        }

        .resize-handle-top::after {
            content: '';
            width: 30px;
            height: 3px;
            background: #ccc;
            border-top: 1px solid #bbb;
            border-bottom: 1px solid #bbb;
        }

        .btn-primary {
            background: var(--lg-red);
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: #fff;
            margin: 5vh auto;
            padding: 35px;
            width: 90%;
            max-width: 850px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .visual-table {
            width: auto;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .visual-table th,
        .visual-table td {
            padding: 6px;
        }

        .visual-table .cell-input {
            min-width: 50px;
            min-height: 24px;
            outline: none !important;
            padding: 4px 6px;
            font-size: 14px;
            box-sizing: border-box;
            font-family: inherit;
            line-height: 1.4;
            background: transparent;
            word-break: break-all;
            white-space: pre-wrap;
        }

        .visual-table .cell-input:empty:before {
            content: attr(data-placeholder);
            color: #999;
            pointer-events: none;
        }

        .color-picker-popup {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 15px;
            z-index: 10000;
            display: none;
            width: 260px;
            border-radius: 8px;
        }

        .cp-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 6px;
            margin: 8px 0;
        }

        .cp-cell {
            width: 20px;
            height: 20px;
            border: 1px solid #eee;
            cursor: pointer;
            border-radius: 2px;
            transition: transform 0.15s;
        }

        .cp-cell:hover {
            transform: scale(1.3);
            z-index: 2;
            border-color: #333;
        }

        .cp-section-title {
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            margin-top: 12px;
            margin-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 4px;
        }

        .cp-more-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #555;
            border-radius: 4px;
        }

        .cp-more-btn:hover {
            background: #f5f5f5;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
                height: auto;
            }

            .editor-panel,
            .preview-panel {
                width: 100%;
                height: auto;
                border-right: none;
            }

            .mobile-tabs {
                display: flex;
            }

            .preview-panel {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="mobile-tabs">
        <button id="btnTabEdit" class="active" onclick="switchTab('edit')">입력</button>
        <button id="btnTabPreview" onclick="switchTab('preview')">미리보기</button>
    </div>

    <div class="container">
        <div class="editor-panel">
            <div class="sticky-header"
                style="margin: -25px -30px 25px -30px; border-radius: 10px 10px 0 0; padding-bottom: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <div class="panel-title" style="margin-bottom:0;"><i class="fas fa-file-alt"></i> 업무 표준 변환기</div>
                    <button class="btn-primary" onclick="generateHTML()"
                        style="background:var(--lg-red); color:#fff; border:none; padding:8px 20px; border-radius:6px; font-weight:700;"><i
                            class="fas fa-magic"></i> 변환하기</button>
                </div>
                <!-- 단일 고정 툴바 -->
                <div id="mainToolbar" class="editor-toolbar"
                    style="top: 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; position: static; box-shadow: none;">
                    <!-- JS에서 TOOLBAR_HTML 주입 -->
                </div>
            </div>

            <!-- Sections: Background, Product, Symptom Summary, Part Info -->

            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" value="배경" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('info_bg')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="info_bg" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="배경 내용을 입력하세요..."></div>
                </div>
            </div>
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" value="제품" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('info_product')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="info_product" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="제품 정보를 입력하세요..."></div>
                </div>
            </div>
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" value="증상" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('info_symptom')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="info_symptom" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="증상을 입력하세요..."></div>
                </div>
            </div>
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" value="부품 정보" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('info_partInfo')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="info_partInfo" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="부품 정보를 입력하세요..."></div>
                </div>
            </div>

            <hr style="border: none; border-top: 1px solid #eee; margin: 40px 0;">

            <!-- Main Sections: Symptom, Cause, Repair -->
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" id="inSymptomTitle" value="현상 및 증상"
                        title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('inSymptom')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="inSymptom" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="현상을 입력하세요..."></div>
                </div>
            </div>
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" id="inCauseTitle" value="원인" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('inCause')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="inCause" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="원인을 입력하세요..."></div>
                </div>
            </div>
            <div class="form-group">
                <div class="label-row">
                    <input class="editable-label" type="text" id="inRepairTitle" value="조치 방법" title="클릭하여 소제목 수정 가능" />
                    <button class="btn-clear-section" onclick="clearSection('inRepairMethod')" title="내용 지우기"><i
                            class="fas fa-times"></i> 지우기</button>
                </div>
                <div class="editor-container">
                    <div id="inRepairMethod" class="editor-content-view paste-area" contenteditable="true"
                        placeholder="조치 방법을 입력하세요..."></div>
                </div>
            </div>

            <div id="dynamicSections"></div>
            <button class="btn-add-section" onclick="addDynamicSection()"><i class="fas fa-plus"></i> 추가 섹션 삽입</button>
        </div>

        <div class="preview-panel">
            <div class="panel-title"><i class="fas fa-eye"></i> 결과 데이터 미리보기</div>
            <div id="previewContainer" class="preview-frame">
                <div style="padding: 100px; text-align: center; color: #999;">
                    <i class="fas fa-code"
                        style="font-size: 48px; display: block; margin-bottom: 20px; opacity: 0.3;"></i>
                    변환 버튼을 누르면 이 곳에 결과가 표시됩니다.
                </div>
            </div>

            <div class="code-area">
                <div id="codeResizeHandle" class="resize-handle-top" title="드래그하여 크기 조절"></div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; background: #333; padding: 10px 15px; border-radius: 8px 8px 0 0;">
                    <span style="color: #fff; font-size: 13px; font-weight: 700;"><i class="fas fa-terminal"
                            style="margin-right:8px; color:#4ec9b0;"></i> 생성된 HTML 코드</span>
                    <button class="btn-primary" onclick="copyCode()" style="padding: 5px 15px; font-size: 12px;"><i
                            class="fas fa-copy" style="margin-right: 5px;"></i> 코드 복사</button>
                </div>
                <textarea id="codeOutput" readonly placeholder="이 곳에 결과 코드가 생성됩니다..."></textarea>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeTableModal()">&times;</span>
            <h2 style="margin-top:0;">표 삽입</h2>
            <div
                style="display:flex; gap:20px; align-items:center; margin-bottom:20px; background:#f8f9fa; padding:15px; border-radius:8px;">
                <label>행 <input type="number" id="tblRows" value="3" min="1" style="width: 60px;"></label>
                <label>열 <input type="number" id="tblCols" value="2" min="1" style="width: 60px;"></label>
                <button class="btn-secondary" onclick="generateVisualTable()">표 구성 초기화</button>
            </div>
            <div id="visualTableContainer" style="max-height: 400px; overflow: auto; padding: 2px;"></div>
            <div style="text-align: right; margin-top: 25px; display:flex; gap:10px; justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeTableModal()">취소</button>
                <button class="btn-primary" onclick="insertTableFromModal()">에디터에 삽입</button>
            </div>
        </div>
    </div>

    <div id="customColorPicker" class="color-picker-popup" onmousedown="event.preventDefault()">
        <div class="cp-section-title">테마 색상</div>
        <div id="themeColorsGrid" class="cp-grid"></div>
        <div class="cp-section-title">표준 색상</div>
        <div id="standardColorsRow" class="cp-grid"></div>
        <div class="cp-section-title">기타</div>
        <div class="cp-more-btn" onclick="triggerNativeColorInput()"><i class="fas fa-palette"></i> 다른 색 선택...</div>
        <input type="color" id="nativeColorInput" style="display:none;" onchange="selectQuickColor(this.value)">
    </div>

    <script>
        // --- Shared Toolbar HTML ---
        const TOOLBAR_HTML = `
            <select onchange="changeFontFamily(this)" class="font-family-select">
                <option value="맑은 고딕" selected>맑은 고딕</option>
                <option value="돋움">돋움</option>
                <option value="굴림">굴림</option>
                <option value="바탕">바탕</option>
                <option value="Arial">Arial</option>
            </select>
            <select onchange="changeFontSize(this)" class="font-size-select">
                <option value="1">8</option><option value="2">10</option><option value="3" selected>11</option>
                <option value="4">14</option><option value="5">18</option><option value="6">24</option><option value="7">36</option>
            </select>
            <button onclick="stepFontSize(1)" class="btn-font-step">가<span>+</span></button>
            <button onclick="stepFontSize(-1)" class="btn-font-step">가<span>-</span></button>
            <div class="color-tool-split">
                <button class="color-btn-main" onclick="applyLastColor('foreColor', event)"><div class="color-icon-wrapper"><b>가</b><div class="color-bar" style="background-color: red;"></div></div></button>
                <button class="color-btn-arrow" onclick="openColorTool('foreColor', event)"><i class="fas fa-caret-down"></i></button>
            </div>
            <button onclick="insertFormat('bold')"><i class="fas fa-bold"></i></button>
            <button onclick="insertFormat('italic')"><i class="fas fa-italic"></i></button>
            <button onclick="insertFormat('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
            <button onclick="insertFormat('insertOrderedList')"><i class="fas fa-list-ol"></i></button>
            <button onclick="openTableModal(event)"><i class="fas fa-table"></i></button>
        `;

        // --- Editor Core ---
        let lastFocusedEditor = null, selectionRange = null, activeToolbar = null, activeColorType = 'foreColor';
        let isRowResizing = false, isColResizing = false, startX, startY, startW, startH, startTableW, targetCell, targetRow;
        let isPendingColResize = false, isPendingRowResize = false;
        let isR = false, sY, sH; // For Code Area Resize

        function saveSelectionState() {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) selectionRange = sel.getRangeAt(0);
        }
        function restoreSelectionState() {
            if (selectionRange && lastFocusedEditor) {
                lastFocusedEditor.focus();
                const sel = window.getSelection();
                sel.removeAllRanges(); sel.addRange(selectionRange);
            } else if (lastFocusedEditor) lastFocusedEditor.focus();
        }

        function insertFormat(cmd, val = null) { restoreSelectionState(); document.execCommand(cmd, false, val); }
        function insertHTML(html) { restoreSelectionState(); document.execCommand('insertHTML', false, html); }
        function insertImage(input) {
            if (!input.files || input.files.length === 0) return;
            const reader = new FileReader();
            reader.onload = e => { insertHTML(`<div class="img-only"><img src="${e.target.result}" style="max-width:100%; height:auto; border:1px solid #eee;"></div><p><br></p>`); };
            reader.readAsDataURL(input.files[0]);
            input.value = '';
        }
        function changeFontFamily(s) { restoreSelectionState(); document.execCommand('fontName', false, s.value); }
        function changeFontSize(s) { restoreSelectionState(); document.execCommand('fontSize', false, s.value); }
        function stepFontSize(d) {
            restoreSelectionState();
            let cur = parseInt(document.queryCommandValue('fontSize')) || 3;
            document.execCommand('fontSize', false, Math.max(1, Math.min(7, cur + d)));
        }

        function clearEditor(btn) {
            if (lastFocusedEditor && confirm('정말 내용을 지우시겠습니까?')) {
                lastFocusedEditor.innerHTML = '';
            }
        }
        function clearSection(id) {
            const el = document.getElementById(id);
            if (el && confirm('내용을 지우시겠습니까?')) el.innerHTML = '';
        }


        // --- Colors ---
        function applyLastColor(type, e) {
            e.stopPropagation(); activeColorType = type;
            const color = e.currentTarget.querySelector('.color-bar').style.backgroundColor || 'red';
            if (type === 'foreColor') changeColor(color); else changeBgColor(color);
        }
        function openColorTool(type, e) {
            e.stopPropagation(); activeColorType = type;
            activeToolbar = e.currentTarget.closest('.color-tool-split');
            const p = document.getElementById('customColorPicker'), r = e.currentTarget.getBoundingClientRect();
            p.style.display = 'block'; p.style.top = (window.scrollY + r.bottom + 5) + 'px';
            p.style.left = Math.min(r.left, window.innerWidth - 275) + 'px';
        }
        function changeColor(c) {
            restoreSelectionState();
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && sel.getRangeAt(0).collapsed && lastFocusedEditor) {
                const span = document.createElement('span');
                span.style.color = c;
                span.appendChild(document.createTextNode('\u200B'));
                const range = sel.getRangeAt(0);
                range.insertNode(span);
                range.setStart(span.firstChild, 1);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('foreColor', false, c);
            }
            document.querySelectorAll('.color-bar').forEach(b => b.style.backgroundColor = c);
        }
        function changeBgColor(c) {
            restoreSelectionState();
            const sel = window.getSelection();
            if (sel.rangeCount > 0 && sel.getRangeAt(0).collapsed && lastFocusedEditor) {
                const span = document.createElement('span');
                span.style.backgroundColor = c;
                span.appendChild(document.createTextNode('\u200B'));
                const range = sel.getRangeAt(0);
                range.insertNode(span);
                range.setStart(span.firstChild, 1);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('hiliteColor', false, c);
            }
            document.querySelectorAll('.color-bar').forEach(b => b.style.backgroundColor = c);
        }
        function selectQuickColor(c) {
            if (activeColorType === 'foreColor') changeColor(c); else changeBgColor(c);
            document.getElementById('customColorPicker').style.display = 'none';
        }
        function triggerNativeColorInput() { document.getElementById('nativeColorInput').click(); }

        function initColorPicker() {
            const theme = ['#ffffff', '#000000', '#eeece1', '#1f497d', '#4f81bd', '#c0504d', '#9bbb59', '#8064a2', '#4bacc6', '#f79646', '#f2f2f2', '#7f7f7f', '#ddd9c3', '#c6d9f0', '#dbe5f1', '#f2dcdb', '#ebf1de', '#e5e0ec', '#dbeef3', '#fdeada', '#d8d8d8', '#595959', '#c4bd97', '#8db3e2', '#b8cce4', '#e5b9b7', '#d7e3bc', '#ccc1d9', '#b7dde8', '#fbd5b5', '#bfbfbf', '#3f3f3f', '#938953', '#548dd4', '#95b3d7', '#d99694', '#c3d69b', '#b2a2c7', '#92cddc', '#fac08f', '#a5a5a5', '#262626', '#494429', '#17365d', '#366092', '#953734', '#76923c', '#5f497a', '#31859b', '#e36c09', '#7f7f7f', '#0c0c0c', '#1d1b10', '#0f243e', '#244061', '#632423', '#4f6128', '#3f3151', '#205867', '#974806'];
            const std = ['#c00000', '#ff0000', '#ffc000', '#ffff00', '#92d050', '#00b050', '#00b0f0', '#0070c0', '#002060', '#7030a0'];
            const tg = document.getElementById('themeColorsGrid'), sg = document.getElementById('standardColorsRow');
            theme.forEach(c => { const d = document.createElement('div'); d.className = 'cp-cell'; d.style.backgroundColor = c; d.onclick = () => selectQuickColor(c); tg.appendChild(d); });
            std.forEach(c => { const d = document.createElement('div'); d.className = 'cp-cell'; d.style.backgroundColor = c; d.onclick = () => selectQuickColor(c); sg.appendChild(d); });
            document.addEventListener('click', () => document.getElementById('customColorPicker').style.display = 'none');
            document.getElementById('customColorPicker').onclick = e => e.stopPropagation();
        }

        // --- Sections ---
        function addDynamicSection() {
            const id = 'dyn_' + Date.now();
            const wrapper = document.createElement('div'); wrapper.className = 'dynamic-section'; wrapper.id = id;
            wrapper.innerHTML = `
                <button class="btn-remove-section" onclick="document.getElementById('${id}').remove()"><i class="fas fa-times"></i></button>
                <div class="form-group"><label>추가 섹션 제목</label><input type="text" class="dyn-title" placeholder="소제목 입력"></div>
                <div class="editor-container">
                    <div class="editor-content-view paste-area dyn-content" contenteditable="true" placeholder="내용을 입력하세요..."></div>
                </div>`;
            document.getElementById('dynamicSections').appendChild(wrapper);
            const ed = wrapper.querySelector('.paste-area');
            ed.addEventListener('paste', handlePaste);
            ed.addEventListener('focus', () => { lastFocusedEditor = ed; saveSelectionState(); });
            ed.addEventListener('mouseup', saveSelectionState);
            ed.addEventListener('keyup', saveSelectionState);
        }

        // --- Table ---
        function openTableModal(e) {
            if (!lastFocusedEditor) { alert('표를 삽입할 위치를 먼저 클릭해주세요.'); return; }
            document.getElementById('tableModal').style.display = 'block'; generateVisualTable();
        }
        function closeTableModal() { document.getElementById('tableModal').style.display = 'none'; }
        function generateVisualTable() {
            const r = parseInt(document.getElementById('tblRows').value);
            const c = parseInt(document.getElementById('tblCols').value);
            let h = '<table class="visual-table" cellspacing="0" cellpadding="0" style="border-collapse:collapse; border-spacing:0; width:auto;"><tbody>';
            for (let i = 0; i < r; i++) {
                h += '<tr>';
                for (let j = 0; j < c; j++) h += `<td style="border:1px solid #999; padding:6px 8px;"><div class="cell-input" contenteditable="true" data-placeholder="내용"></div></td>`;
                h += '</tr>';
            }
            h += '</tbody></table>';
            document.getElementById('visualTableContainer').innerHTML = h;
        }
        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }
        function insertTableFromModal() {
            if (!lastFocusedEditor) return;
            const mt = document.querySelector('.visual-table');
            const toHtml = v => v ? v.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>') : '&nbsp;';

            let out = `<div class="tbl-scroll">\n<table style="width: auto;" class="xfe_just_info">\n`;
            const rows = Array.from(mt.querySelectorAll('tbody tr'));
            if (rows.length > 0) {
                out += '<thead>\n<tr>\n';
                rows[0].querySelectorAll('.cell-input').forEach(i => {
                    out += `<th style="padding: 8px;">${toHtml(i.innerText)}</th>\n`;
                });
                out += '</tr>\n</thead>\n<tbody>\n';
                for (let i = 1; i < rows.length; i++) {
                    out += '<tr>\n';
                    rows[i].querySelectorAll('.cell-input').forEach(cell => {
                        out += `<td style="padding: 8px;">${toHtml(cell.innerText)}</td>\n`;
                    });
                    out += '</tr>\n';
                }
                out += '</tbody>\n';
            } else {
                out += '<tbody>\n</tbody>\n';
            }
            out += '</table>\n</div>\n<p><br></p>\n';
            lastFocusedEditor.focus(); insertHTML(out); closeTableModal();
        }

        // --- Paste & HTML ---
        function handlePaste(e) {
            const d = e.clipboardData, t = d.getData('text/plain');
            if (t && t.indexOf('\t') !== -1) {
                e.preventDefault();
                const lines = t.trim().split(/\r\n|\n|\r/), rows = lines.map(line => line.split('\t')), max = Math.max(...rows.map(r => r.length));

                let h = `<div class="tbl-scroll">\n<table style="width: auto;" class="xfe_just_info">\n<thead>\n<tr>\n`;
                rows[0].forEach(c => h += `<th style="padding: 8px;">${c || '&nbsp;'}</th>\n`);
                for (let j = rows[0].length; j < max; j++) h += `<th style="padding: 8px;">&nbsp;</th>\n`;
                h += '</tr>\n</thead>\n<tbody>\n';
                for (let i = 1; i < rows.length; i++) {
                    h += '<tr>\n';
                    rows[i].forEach(c => h += `<td style="padding: 8px;">${c || '&nbsp;'}</td>\n`);
                    for (let j = rows[i].length; j < max; j++) h += `<td style="padding: 8px;">&nbsp;</td>\n`;
                    h += '</tr>\n';
                }
                h += '</tbody>\n</table>\n</div>\n<p><br></p>\n';
                insertHTML(h); return;
            }
            if (t && t.trim().length > 0) { e.preventDefault(); insertHTML(t.replace(/\n/g, '<br>')); return; }
            for (let item of d.items) {
                if (item.type.startsWith('image/')) {
                    e.preventDefault(); const reader = new FileReader();
                    reader.onload = ev => insertHTML(`<div class="img-only"><img src="${ev.target.result}" style="max-width:100%; height:auto; border:1px solid #eee;"></div><p><br></p>`);
                    reader.readAsDataURL(item.getAsFile()); break;
                }
            }
        }

        function generateHTML() {
            const infoIds = [['배경', 'info_bg'], ['제품', 'info_product'], ['증상', 'info_symptom'], ['부품 정보', 'info_partInfo']];
            let ih = '';
            infoIds.filter(([l, id]) => document.getElementById(id).innerText.trim().length > 0 || document.getElementById(id).querySelector('img, table')).forEach(([l, id]) => {
                ih += `<div style="margin-bottom:15px;"><div style="margin-bottom:6px;"><span style="background-color:#e2e2e2; padding:3px 12px; border-radius:4px; font-weight:bold; font-size:14px;">※ ${l}</span></div><div style="font-size:14px; padding-left:10px;">${document.getElementById(id).innerHTML}</div></div>`;
            });
            if (ih) ih = `<div style="margin-bottom: 20px;">${ih}</div>`;

            let ch = ih;
            const add = (t, c) => {
                const has = c.trim().replace(/<br>/g, '').length > 0 || c.includes('<img') || c.includes('<table');
                if (has) ch += `<div style="margin-bottom: 20px;">${c}</div>`;
            };
            add(document.getElementById('inSymptomTitle').value, document.getElementById('inSymptom').innerHTML);
            add(document.getElementById('inCauseTitle').value, document.getElementById('inCause').innerHTML);
            add(document.getElementById('inRepairTitle').value, document.getElementById('inRepairMethod').innerHTML);
            document.querySelectorAll('.dynamic-section').forEach(s => add(s.querySelector('.dyn-title').value || '섹션', s.querySelector('.dyn-content').innerHTML));

            // Wrap result to handle absolute children positioning in the container
            const finalCh = `<div style="position:relative; min-height:400px; width:100%;">\n${ch}\n</div>`;
            document.getElementById('previewContainer').innerHTML = `<div class="content-service-view" style="padding:20px;">\n${finalCh}\n</div>`;

            // HTML 포맷팅 (줄바꿈 추가)
            const formattedCh = ch.replace(/(<div|<h3|<p|<table|<tbody|<thead|<tr)/g, '\n        $1').replace(/(<\/div>|<\/table>)/g, '$1\n');

            const out = `<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <style>
        .content-service-view { font-family: 'Noto Sans KR', sans-serif; line-height: 1.6; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; text-align: left; }
        .sub-tit { position: relative; padding-left: 25px; margin: 30px 0 10px; font-size: 18px; font-weight: bold; }
        .sub-tit .num { position: absolute; left: 0; top: 2px; width: 20px; height: 20px; background: #999; color: #fff; border-radius: 50%; text-align: center; font-size: 12px; line-height: 20px; display: inline-block; }
        .tbl-scroll { overflow-x: auto; margin: 15px 0; }
        .xfe_just_info { width: auto; border-collapse: collapse; table-layout: auto; }
        .xfe_just_info th, .xfe_just_info td { border: 1px solid #ccc; padding: 8px; white-space: pre-wrap; word-break: break-all; text-align: left; }
        .img-only { margin: 20px 0; text-align: left; }
        .img-only img { max-width: 100%; height: auto; border: 1px solid #eee; }
        p { margin: 10px 0; }
    </style>
</head>
<body>
    <div class="content-service-view" style="position:relative; min-height:600px;">
${formattedCh}
    </div>
</body>
</html>`;
            document.getElementById('codeOutput').value = out;
            if (window.innerWidth <= 1024) switchTab('preview');
        }

        function copyCode() { const v = document.getElementById('codeOutput').value; if (!v) return alert('변환 버튼을 먼저 눌러주세요.'); navigator.clipboard.writeText(v).then(() => alert('코드가 복사되었습니다.')); }
        function switchTab(t) {
            document.querySelectorAll('.mobile-tabs button').forEach(b => b.classList.remove('active'));
            document.getElementById('btnTab' + t.charAt(0).toUpperCase() + t.slice(1)).classList.add('active');
            document.querySelector('.editor-panel').style.display = (t === 'edit' ? 'block' : 'none');
            document.querySelector('.preview-panel').style.display = (t === 'preview' ? 'block' : 'none');
        }

        // --- Init ---
        window.addEventListener('DOMContentLoaded', () => {
            initColorPicker();
            // Assign single toolbar
            const tb = document.getElementById('mainToolbar');
            if (tb) {
                tb.innerHTML = TOOLBAR_HTML;
                // Prevent toolbar from stealing focus from editor on ALL clicks
                tb.addEventListener('mousedown', e => { e.preventDefault(); });
            }

            // Bind events for all scattered editors
            document.querySelectorAll('.editor-content-view').forEach(ed => {
                ed.addEventListener('paste', handlePaste);
                ed.addEventListener('focus', () => { lastFocusedEditor = ed; saveSelectionState(); });
                ed.addEventListener('mouseup', saveSelectionState);
                ed.addEventListener('keyup', saveSelectionState);
            });

            // Set default focus safely
            const firstEd = document.getElementById('info_bg');
            if (firstEd) lastFocusedEditor = firstEd;

            // Resize handle logic
            const h = document.getElementById('codeResizeHandle'), t = document.getElementById('codeOutput');
            if (h && t) {
                h.onmousedown = (e) => { isR = true; sY = e.clientY; sH = t.offsetHeight; document.body.style.cursor = 'ns-resize'; e.preventDefault(); };
            }

            // Table Resize (Unified Row & Column)

            document.addEventListener('mousedown', e => {
                const cell = e.target.closest('.editor-content-view td, .editor-content-view th');
                if (!cell) return;

                const rect = cell.getBoundingClientRect();
                const isRightEdge = Math.abs(e.clientX - rect.right) < 20;
                const isLeftEdge = Math.abs(e.clientX - rect.left) < 20;
                const isBottomEdge = Math.abs(e.clientY - rect.bottom) < 20;

                const tbl = cell.closest('table');
                if (!tbl) return;

                if (isRightEdge || isLeftEdge || isBottomEdge) {
                    startX = e.clientX;
                    startY = e.clientY;
                    if (isRightEdge || isLeftEdge) {
                        isPendingColResize = true;
                        targetCell = isRightEdge ? cell : cell.previousElementSibling;
                    } else {
                        isPendingRowResize = true;
                        targetRow = cell.parentElement;
                    }
                    // Prevent text selection during pending resize
                    document.body.style.userSelect = 'none';
                }
            });

            function startColResize(e) {
                if (!targetCell) return;
                const tbl = targetCell.closest('table');
                if (!tbl) return;

                isColResizing = true;
                const cellRect = targetCell.getBoundingClientRect();
                const tblRect = tbl.getBoundingClientRect();
                startW = cellRect.width;
                startTableW = tblRect.width;

                const firstRow = tbl.rows[0];
                if (firstRow) {
                    for (let i = 0; i < firstRow.cells.length; i++) {
                        const c = firstRow.cells[i];
                        c.style.width = c.getBoundingClientRect().width.toFixed(2) + 'px';
                    }
                }
                tbl.style.width = startTableW.toFixed(2) + 'px';
                tbl.style.tableLayout = 'fixed';
                document.body.style.cursor = 'ew-resize';
                e.preventDefault();
            }

            function startRowResize(e) {
                if (!targetRow) return;
                isRowResizing = true;
                startH = targetRow.offsetHeight;
                document.body.style.cursor = 'ns-resize';
                e.preventDefault();
            }

            // Combined Optimized Global Mouse Movements
            let mouseTimer = null;
            window.addEventListener('mousemove', e => {
                const curX = e.clientX, curY = e.clientY;
                if (mouseTimer) return;
                mouseTimer = requestAnimationFrame(() => {
                    // Check if we should start resizing (threshold to prevent jump on click)
                    if (!isColResizing && !isRowResizing) {
                        if (isPendingColResize || isPendingRowResize) {
                            const dist = Math.sqrt(Math.pow(curX - startX, 2) + Math.pow(curY - startY, 2));
                            if (dist > 3) {
                                if (isPendingColResize) startColResize(e);
                                else if (isPendingRowResize) startRowResize(e);
                            }
                        }
                    }

                    // 1. Table Resize
                    if (isColResizing && targetCell) {
                        const diff = curX - startX;
                        const newW = Math.max(30, startW + diff);
                        const tbl = targetCell.closest('table');
                        if (tbl && tbl.rows.length > 0) {
                            const colIndex = targetCell.cellIndex;
                            const masterCell = tbl.rows[0].cells[colIndex];
                            if (masterCell) masterCell.style.width = newW + 'px';
                            tbl.style.width = (startTableW + (newW - startW)) + 'px';
                        }
                    } else if (isRowResizing && targetRow) {
                        const diff = curY - startY;
                        const newH = Math.max(25, startH + diff);
                        targetRow.style.height = newH + 'px';
                        for (let i = 0; i < targetRow.cells.length; i++) {
                            targetRow.cells[i].style.height = newH + 'px';
                        }
                    } else if (!isColResizing && !isRowResizing && !isR) {
                        const cell = e.target.closest('.editor-content-view td, .editor-content-view th');
                        if (cell) {
                            const rect = cell.getBoundingClientRect();
                            const isEdgeX = Math.abs(curX - rect.right) < 20 || Math.abs(curX - rect.left) < 20;
                            const isEdgeY = Math.abs(curY - rect.bottom) < 20;
                            if (isEdgeX) e.target.style.cursor = 'ew-resize';
                            else if (isEdgeY) e.target.style.cursor = 'ns-resize';
                            else e.target.style.cursor = '';
                        }
                    }

                    // 5. Code Area Resize
                    if (isR) {
                        t.style.height = Math.max(100, sH + (sY - curY)) + 'px';
                    }

                    mouseTimer = null;
                });
            });

            window.addEventListener('mouseup', () => {
                isRowResizing = false;
                isColResizing = false;
                isPendingColResize = false;
                isPendingRowResize = false;
                isR = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            });
        });

        window.onclick = (e) => { if (e.target.className === 'modal') closeTableModal(); };
    </script>
</body>

</html>